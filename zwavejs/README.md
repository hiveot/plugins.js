# ZwaveJS binding for HiveOT

This binding connects to a ZWave USB-Stick controller and publishes Wot TD documents and events to the HiveOT message bus.

## Status

This binding is alpha. It is converted to use with hiveot hub but needs further testing.

1. Hub Reconnect support
1. ZWave stick reconnect support (Recover after serial port removal)
1. Update/improve mapping of zwave-js VID names to hiveot property/event/action vocabulary.
1. Include DataSchema in controller configurations for properties that aren't in the zwave-js vids.
1. Dimming duration is currently not supported
1. Load vid override map from file (determines vid prop/event/action and @type)
2. Handle arrays for property/event/action values
   a property with multiple values could be a nested array or a property-{instance}
   tbd

## Build

This needs:

* yarn
* nodejs v18+
* typescript compiler v4.9+ (tsc, included in snap's node)
* make tools

Simply run make dist and watch the magic unfold (...hopefully, this is a javascript build environment after all).

The end result, if all goes according to plan, is a single binary: **dist/zwavejs**

## Installation

Installation needs the executable, an authentication token, and the CA certificate of the Hub.

The binding executable should be copied to the hiveot bindings folder, for example: ~/bin/hiveot/bin/bindings
The authentication token is generated by the launcher, or can be generated manually using the hubcli. The token file has the same name as the executable.
The CA certificate is generated by the hubcli on startup and placed in certs/caCert.pem.

## Run

Before running the binding make sure the hub gateway is running. 'hubcli ls' lists the running processes.

The binding can be launched from the hubcli:
> bin/hubcli start zwavejs

To manually run the binding:
> ~/bin/hiveot/plugins/zwavejs

The binding connects to the Hub gateway using service discovery, or falls back to localhost:{port}. The port can be changed in the
config/zwavejs.yaml configuration file.

On startup if a configuration file doesn't yet exist it is generates into hiveot/config/zwavejs.yaml.
This configuration file contains all sorts of interesting settings such as the serviceID, the ZWave S2 keys, zwave
serial port, and a few other settings. Most importantly in a conventional setup the gateway and serial port are
auto-discovered, so things will just run out of the box.

If you have an existing zwave network with S2 keys then copy these keys into the respective fields in the configuration
file should let it adopt the network, in theory. This has not yet been tested.

To autostart the binding add it to the autostart section of the launcher.yaml configuration file in the config folder.

## Multiple Instances

* Note: This section is fluid.

Each binding instance on the network must have a unique serviceID. This allows for multiple zwave controllers in
different areas.
To run multiple instances with different service IDs rename the executable. For example to zwavejs-1, zwavejs-2, etc. 
The launcher generates keys and tokens for each separately.
Each instance will publish the discovered Things and events under their own serviceID.

